{% extends 'panel/base.html' %}

{% block title %}Панель — Профиль{% endblock %}

{% block panel_heading %}Профиль: {{ profile.display_name|default:profile.user.username }}{% endblock %}
{% block panel_subtitle %}Редактирование анкеты и просмотр прогресса опросников.{% endblock %}

{% block panel_top_actions %}
<a class="rounded-xl border border-white/10 bg-white/5 px-4 py-2 text-sm font-medium hover:bg-white/10" href="{% url 'panel_profiles' %}">Назад</a>
<a class="rounded-xl border border-white/10 bg-white/5 px-4 py-2 text-sm font-medium hover:bg-white/10" href="{% url 'panel_user_detail' profile.user_id %}">Пользователь</a>
<a class="rounded-xl border border-white/10 bg-white/5 px-4 py-2 text-sm font-medium hover:bg-white/10" href="{% url 'public_profile' profile.user_id %}">Public</a>
{% endblock %}

{% block panel_content %}
<div class="grid gap-6 lg:grid-cols-3">
    <div class="lg:col-span-1">
        <div class="rounded-3xl border border-white/10 bg-white/5 p-6">
            <div class="flex items-center gap-4">
                {% if profile.avatar %}
                <img class="h-16 w-16 rounded-2xl object-cover" src="{{ profile.avatar.url }}" alt="avatar" />
                {% else %}
                <div class="h-16 w-16 rounded-2xl bg-white/10"></div>
                {% endif %}
                <div>
                    <div class="text-lg font-semibold">{{ profile.display_name|default:profile.user.username }}</div>
                    <div class="text-sm text-slate-300">{{ profile.city|default:'—' }}</div>
                </div>
            </div>

            <div class="mt-6 border-t border-white/10 pt-5">
                <div class="text-sm font-medium">Прогресс анкет</div>

                <div class="mt-4">
                    <div class="flex items-center justify-between text-sm">
                        <div class="text-slate-200">Я</div>
                        <div class="text-slate-300">{{ me_answered }} / {{ me_total }} ({{ me_percent }}%)</div>
                    </div>
                    <div class="mt-2 h-2 w-full overflow-hidden rounded-full bg-white/10" data-progress="{{ me_percent }}">
                        <div class="h-2 rounded-full bg-fuchsia-500" data-progress-bar></div>
                    </div>
                </div>

                <div class="mt-5">
                    <div class="flex items-center justify-between text-sm">
                        <div class="text-slate-200">Мой идеал</div>
                        <div class="text-slate-300">{{ ideal_answered }} / {{ ideal_total }} ({{ ideal_percent }}%)</div>
                    </div>
                    <div class="mt-2 h-2 w-full overflow-hidden rounded-full bg-white/10" data-progress="{{ ideal_percent }}">
                        <div class="h-2 rounded-full bg-fuchsia-500" data-progress-bar></div>
                    </div>
                </div>
            </div>

            <div class="mt-6 border-t border-white/10 pt-5">
                <div class="flex items-center justify-between">
                    <div class="text-sm font-medium">Фото</div>
                    <a class="text-sm text-slate-300 hover:text-white" href="{% url 'panel_photos' %}?q={{ profile.user.username|urlencode }}">Все</a>
                </div>
                <div class="mt-4 grid grid-cols-3 gap-2">
                    {% for photo in photos %}
                    <img class="h-20 w-full rounded-2xl object-cover" src="{{ photo.image.url }}" alt="photo" />
                    {% empty %}
                    <div class="col-span-3 text-sm text-slate-300">Нет фото.</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div class="lg:col-span-2">
        <div class="rounded-3xl border border-white/10 bg-white/5 p-6">
            <div class="text-sm font-medium">Редактирование профиля</div>

            <form method="post" enctype="multipart/form-data" class="mt-4 space-y-5">
                {% csrf_token %}

                <div class="grid gap-4 md:grid-cols-2">
                    {% for field in form %}
                    <div class="{% if field.name == 'bio' %}md:col-span-2{% endif %}">
                        {{ field.label_tag }}
                        {{ field }}
                        {% if field.errors %}
                        <div class="mt-1 text-sm text-rose-300">{{ field.errors }}</div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>

                <button type="submit" class="rounded-xl bg-fuchsia-500 px-5 py-3 font-medium text-white hover:bg-fuchsia-400">Сохранить</button>
            </form>
        </div>

        <div class="mt-6 rounded-3xl border border-white/10 bg-white/5 p-6">
            <div class="flex items-center justify-between">
                <div class="text-sm font-medium">Ответы анкеты</div>
                <div class="text-sm text-slate-300">{{ me_answered }}/{{ me_total }} · {{ ideal_answered }}/{{ ideal_total }}</div>
            </div>

            <div class="mt-5 space-y-8">
                <div>
                    <div class="text-sm font-medium text-slate-200">Я</div>
                    <div class="mt-4 space-y-5">
                        {% for section in questionnaire_sections %}
                        <div class="rounded-2xl border border-white/10 bg-slate-950/30 p-5">
                            <div class="text-sm font-semibold">{{ section.title }}</div>

                            <div class="mt-4 space-y-3">
                                {% for q in section.questions %}
                                <div class="rounded-2xl border border-white/10 bg-slate-950/40 p-4">
                                    <div class="text-sm text-slate-100">{{ q.text }}</div>

                                    <div class="mt-3 rounded-2xl border border-white/10 bg-white/5 p-4">
                                        <div class="text-xs text-slate-400">Ответ</div>
                                        <div class="mt-1 text-sm {% if q.me_answered %}text-slate-100{% else %}text-slate-400{% endif %}">{{ q.me_label }}</div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div>
                    <div class="text-sm font-medium text-slate-200">Мой идеал</div>
                    <div class="mt-4 space-y-5">
                        {% for section in questionnaire_sections_ideal %}
                        <div class="rounded-2xl border border-white/10 bg-slate-950/30 p-5">
                            <div class="text-sm font-semibold">{{ section.title }}</div>

                            <div class="mt-4 space-y-3">
                                {% for q in section.questions %}
                                <div class="rounded-2xl border border-white/10 bg-slate-950/40 p-4">
                                    <div class="text-sm text-slate-100">{{ q.text }}</div>

                                    <div class="mt-3 rounded-2xl border border-white/10 bg-white/5 p-4">
                                        <div class="text-xs text-slate-400">Ответ</div>
                                        <div class="mt-1 text-sm {% if q.ideal_answered %}text-slate-100{% else %}text-slate-400{% endif %}">{{ q.ideal_label }}</div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-sm text-slate-300">Нет вопросов.</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
